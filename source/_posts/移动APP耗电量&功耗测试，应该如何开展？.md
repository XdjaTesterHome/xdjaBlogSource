---
title: 移动APP耗电量&功耗测试，应该如何开展？
date: 2016-11-3 13:48:58
tags: APP性能测试 耗电量 功耗 功耗仪器 内存 CPU 流量 应用启动 专项测试 功耗仪耗电分析 客户端性能测试
categories: 实例分析
---
---

     移动APP功耗测试如何开展？我们通过什么工具进行移动APP的功耗测试？
一、耗电测试工具和方法：1、使用功耗仪器进行安卓系统和安卓系统APP的功耗测试，测试结果是APP+系统的总耗电量；但是我们可以通过系统总耗电量的大小来判断APP耗电量是否达标，这是我们的目的。
     首先我们了解下系统耗电与那些模块相关：硬件方面，1、lcd、蓝牙、WIFI、网络模块（2G/3G/4G）,BP等；软件方面：1、系统服务、常住服务、对网络数据操作是否频繁；以上因素是影响耗电的根本因素。
     
二、耗电量测试对APP的执行标准
     如何来判断一个应用是过于耗电的，首先我们在使用功耗仪器测试的过程中，影响平均电流的因素有：1、基准底电。2、心跳频繁程度。3、毛刺的大小和数量。4、应用是否有额外的常驻服务。其中2和3主要是对网络的操作，对功耗影响也最为常见。
     对于测试的APP耗电是否pass，通常情况下按照如下标准定义：
     1、安装被测试应用后，系统耗电平均电流无明显增加；（如灭屏待机耗电在5——10mA;亮屏待机平均电流在：180——230mA;注意每款机器的情况略有不同，需要针对所测机型根据测试结果定义）
     2、操作被测APP主要业务后，灭屏待机和亮屏待机不能有明显过高的电量消耗。（如操作业务后，系统不能正常进行待机）
     3、被测APP不能有不合理的常驻服务，造成耗电持续偏高。
     实际遇到的常见问题
     如我在接触并使用功耗仪器：3年左右时间，遇到的在测试软件方面的问题：
     1、操作主要业务后，灭屏无法进入待机，灭屏电流在150mA左右，网络模块无法进入休眠。
     2、灭屏情况下，接受被动业务，如消息或者推送，连续接收后，网络模块一直处于较高耗电中，无法休眠。（联通4G的网络模块电流一般在150mA左右，移动4G或者联通3G/2G情况下的网络模块电流是不一样的，需要你自己实践测试得出参考数值。）
     3、亮屏4g情况下，网络模块一直处于工作状态，耗电持续高达350mA左右，对于这种问题是一定需要优化的。
     下面看图：这是一个后台有常驻服务的情况，直接灭屏底电高达14.4mA；正常情况下是4mA左右。
     正常情况下灭屏耗电：
     ![down_start](/upload/image/lzz/down.JPG)
     异常情况下灭屏耗电：
     ![error_start](/upload/image/lzz/down-error.JPG)
     通过对比发现，2次的结果虽然都是在灭屏情况下测试的，但实际差异比较大，通过亮屏查看手机系统的情况，发现下拉通知栏，XXX应用有一条消息通知服务：XXX应用应用有新的版本，请及时更新。。。
     这就说明应用有一条服务处于常驻进程中，及时在灭屏情况下也在工作中，这是不允许的，因为造成了多于10mA左右的额外耗电。
三、移动APP功耗测试问题常见分析，功耗仪器测试波形图分析：
     1、首先测试功耗的时候，我们会关注网络心跳和毛刺，因为太多的网络心跳和网络操作必然造成较高的耗电，而这种高耗电又是APP引起的，那么我们不得不进行优化。
     （1）、使用adb命令获取应用的网络心跳情况：
     adb shell dumpsys alarm 
     具体使用方法是，dumpsys出来测试开始和结束时的alarm数据，并查找到用户进程的wakeups数据，前后相减获得这段时间应用的唤醒次数和时间。
     下面是20分钟测试的alarm数据：
     开始的数据：
     ![alarm_start](/upload/image/lzz/wakeup1.JPG)
     20min后的测试数据：
     ![alarm_over](/upload/image/lzz/wakeup2.JPG)
     通过2次测试结果我们发现：
     1、com.xdja.actoma的wakeups次数为：6次（13-7=6）
     2、com.xdja.HDsafeemailclient次数为：5次
     3、com.xdja.xpush次数为：3次
     再仔细查看图片上alarm数据：如第一个安通+，共有2个可以引起心跳的行为：如1、com.xdja.csipsimple.pj_timer ;2、com.xdja.alarm.action；通过alarm数据可以清楚的看到这段时间引发心跳的正是com.xdja.alarm.action，推送方面的业务，较log排查问题更加直观易懂。
     请看下面图片测试的数据，我以安通+应用作为实例进行分析：
     ![down_start_20](/upload/image/lzz/down-20min.JPG)
     另外我们通过对功耗仪器测试的这段时间：20min数据抓取aplog进行分析后；发现与上面dumpsys alarm抓取的这段时间wakeups数据是一致的。
     如：上图的标注：安通+引起了6次网络心跳；xpush引起了3次，上图中标注了2出，因为功耗数据图提前截取了，所以有一次没有截取到；而com.xdja.HDsafeemailclient引起了5次毛刺，为什么不是网络心跳，因为我把手机中这个安全邮件应用给停用了，所以服务无法起来，只能是引起毛刺这样的电流变化；
     部分log参考如下，通过log我们可以看到用户应用这段时间做了哪些操作，为什么会导致电流变化。
     如安通+引发的网络心跳，实际上是推送业务：
     ![actoma](/upload/image/lzz/actoma.JPG)
     如xpush引发的网络操作：
     ![xpush](/upload/image/lzz/xpush-wakeups.JPG)
     综上所述：对于测试同一个应用功耗的时候，我们在测试的过程中，应该同时抓取log信心，这样在拿到电流变化的数据的时候，对比log查看分析一下心跳和毛刺，哪些是属于我们要测试的应用的数据，而这个数据是否处于正常水平；因为功耗仪器测试的是整体的数据，我们首先要排除其他应用心跳和毛刺带来的高耗电；拿到单个应用20min中的心跳数据，才方便我们与后面版本做相同场景下对比测试，使得测试数据更加精准。
     四、耗电测试测试场景
     通过三我们小结一下耗电测试的分析方法：1、功耗仪器测试一段时间的数据变化图样和耗电量平均值数据；2、通过查看log，获取心跳和毛刺的变化情况，哪些属于被测应用的，哪些属于其他应用的，哪些属于系统自身的；3、通过alarm 属于获取这段时间wakeups属于，辅助我们功耗仪器测试的耗电结果，准确定位问题所在。
     移动APP耗电测试场景和范围：
     1、通过adb shell dumpsys alarm 测试应用后台从有网络进入无网络情况下的wakeups唤醒数据，并对比同款机型如QQ、微信做对比测试。（为什么做对比？因为有的手机功能差异比较大，比如有的支持VoIP功能，有的手机就不支持；而这个VoIP功能对耗电影响很大，涉及到通讯模块。）
     2、通过功耗仪器测试：后台应用待机情况下无业务和有业务下的耗电。
     3、操作主要功能和业务，查看手机是否能正常进入待机，待机后电流是否处于正常水平。
     4、操作应用升级的业务和通知栏推送，查看是否有常驻进程，造成应用额外耗电或者底电较高的情况。
     


----------
如果你觉得这篇文章对你很有标注的话，请打赏我们，谢谢支持。。。

![gaveme](/upload/image/lzz/giveme.jpg)
     
     
     
     




